<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Wakeup-Darkness</title>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; }
        .video-container { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        video { width: 45%; border-radius: 8px; border: 2px solid #333; background: black; }
        .controls { margin-top: 20px; padding: 20px; background: #222; display: inline-block; border-radius: 12px; }
        input { padding: 10px; border-radius: 4px; border: none; width: 300px; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:hover { background: #0056b3; }
        button.stop { background: #dc3545; }
        button.stop:hover { background: #a71d2a; }
    </style>
</head>
<body>

    <h1>Wakeup-Darkness Real-Time Enhancer</h1>

    <div class="controls">
        <input type="text" id="promptInput" placeholder="Enter prompt (e.g., 'The man in the street')">
        <button onclick="updatePrompt()">Update Prompt</button>
        <br><br>
        <button onclick="start()" id="startBtn">Start Camera & Enhance</button>
        <button onclick="stop()" class="stop" id="stopBtn" disabled>Stop</button>
    </div>

    <div class="video-container">
        <div>
            <h3>Original (Webcam)</h3>
            <video id="localVideo" autoplay playsinline muted></video>
        </div>
        <div>
            <h3>Enhanced (Server Stream)</h3>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
    </div>

    <script>
        let pc = null;
        let localStream = null;
        // Generate a random session ID
        const sessionId = Math.random().toString(36).substring(7);

        async function start() {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            // 1. Get User Media (Webcam)
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480 }, // Lower res = Faster processing
                audio: false 
            });
            document.getElementById('localVideo').srcObject = localStream;

            // 2. Create Peer Connection
            pc = new RTCPeerConnection();

            // 3. Add local tracks to Peer Connection
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            // 4. Handle incoming stream (Enhanced video from server)
            pc.ontrack = (event) => {
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    console.log('Received remote stream');
                }
            };

            // 5. Negotiate (SDP Offer/Answer)
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Send offer to server
            const response = await fetch('/offer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sdp: pc.localDescription.sdp,
                    type: pc.localDescription.type,
                    session_id: sessionId
                })
            });

            const answer = await response.json();
            await pc.setRemoteDescription(answer);
        }

        async function updatePrompt() {
            const prompt = document.getElementById('promptInput').value;
            await fetch('/update_prompt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId, prompt: prompt })
            });
            console.log("Prompt updated to:", prompt);
        }

        function stop() {
            if (pc) {
                pc.close();
                pc = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }
    </script>
</body>
</html>